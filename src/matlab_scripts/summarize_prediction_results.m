%% summarize_prediction_results.m
%
% This is a function to generate summary plots for the prediction results
%
% - written by: Dimitri Lezcano


%% 
function summarize_prediction_results(...
    prediction_results_file, actual_results_file...
)
    %% Arguments block
    arguments
        prediction_results_file string
        actual_results_file string
    end
    
    %% Load the results table
    act_results_tbl  = load( actual_results_file ).act_result_tbl;
    pred_results_tbl = readtable( prediction_results_file, ...
        'TextType', 'string'...
    );

    %% Generate data masks
    % single-bend single-layer
    act_sb_sl_mask  = ...
        act_results_tbl.singlebend ...
        & act_results_tbl.num_layers == 1 ...
    ;
    pred_sb_sl_mask = ...
        pred_results_tbl.singlebend ...
        & pred_results_tbl.num_layers == 1 ...
    ;

    % single-bend double-layer 
    act_sb_sl_mask  = ...
        act_results_tbl.singlebend ...
        & act_results_tbl.num_layers == 2 ...
    ;
    pred_sb_dl_mask = ...
        pred_results_tbl.singlebend ...
        & pred_results_tbl.num_layers == 2 ...
    ;

    % double-bend single-layer mask
    act_db_sl_mask  = ...
        ~act_results_tbl.singlebend ...
        & act_results_tbl.num_layers == 1 ...
    ;
    pred_db_sl_mask = ...
        ~pred_results_tbl.singlebend ...
        & pred_results_tbl.num_layers == 1 ...
    ;

    % mask for no duplicates
    fwdpred_mask = pred_results_tbl.L_ref < pred_results_tbl.L_pred;
    nodup_mask   = ...
        pred_results_tbl.layer_num == 1 ...
        & pred_results_tbl.L_ref ~= pred_results_tbl.L_pred ...
        & fwdpred_mask ...
    ;    
    %% label prediction results per experiment
    % prepare prediction results table
    pred_results_tbl.Experiment_Type = repmat(...
        "",...
        size(pred_results_tbl, 1), 1 ...
    );
    
    % Add experiment types
    pred_results_tbl.Experiment_Type(pred_sb_sl_mask) = "single-bend single-layer";
    pred_results_tbl.Experiment_Type(pred_sb_dl_mask) = "single-bend double-layer";
    pred_results_tbl.Experiment_Type(pred_db_sl_mask) = "double-bend single-layer";
    
    % Generate experiment-correspondences
    pred_results_tbl = join( ...
      pred_results_tbl, ...
      unique(...
        act_results_tbl(:, ["Experiment", "TissueType1", "TissueType2"])...
      ), ...
      "Key", "Experiment" ...
    );

    pred_results_tbl.dL = pred_results_tbl.L_pred - pred_results_tbl.L_ref;

    %% Prepare statistics
    error_varnames = reshape(["FBG_Pred_", "FBG_Cam_", "Pred_Cam_"] + [
            "RMSE"; "MaxError"; "InPlaneError"; "OutPlaneError"
        ], ...
    1, []);
    error_sumfuncs = {'mean', 'max', 'std'};

    %% Perform statistics on single-bend single-layer results
    sb_sl_pred_summ_L = groupsummary( ...
        pred_results_tbl(pred_sb_sl_mask & nodup_mask, :), ...
        {'L_ref', 'L_pred'}, ...
        error_sumfuncs, ...
        error_varnames ...
    );

    sb_sl_pred_tissue = groupsummary( ...
        pred_results_tbl(pred_sb_sl_mask & nodup_mask, :), ...
        {'TissueType1'}, ...
        error_sumfuncs, ...
        error_varnames ...
    );

    sb_sl_pred_inshole = groupsummary( ...
        pred_results_tbl(pred_sb_sl_mask & nodup_mask, :), ...
        {'Ins_Hole'}, ...
        error_sumfuncs, ...
        error_varnames ...
    );

    %% Perform statistics on single-bend double-layer results
    sb_dl_pred_summ_L = groupsummary( ...
        pred_results_tbl(pred_sb_dl_mask & nodup_mask, :), ...
        {'L_ref', 'L_pred'}, ...
        error_sumfuncs, ...
        error_varnames ...
    );

    sb_dl_pred_tissue = groupsummary( ...
        pred_results_tbl(pred_sb_dl_mask & nodup_mask, :), ...
        {'TissueType1', 'TissueType2'}, ...
        error_sumfuncs, ...
        error_varnames ...
    );

    sb_dl_pred_inshole = groupsummary( ...
        pred_results_tbl(pred_sb_dl_mask & nodup_mask, :), ...
        {'Ins_Hole'}, ...
        error_sumfuncs, ...
        error_varnames ...
    );

    %% Perform statistics on double-bend single-layer results
    db_sl_pred_summ_L = groupsummary( ...
        pred_results_tbl(pred_db_sl_mask & nodup_mask, :), ...
        {'L_ref', 'L_pred'}, ...
        error_sumfuncs, ...
        error_varnames ...
    );

    db_sl_pred_tissue = groupsummary( ...
        pred_results_tbl(pred_db_sl_mask & nodup_mask, :), ...
        {'TissueType1'}, ...
        error_sumfuncs, ...
        error_varnames ...
    );

    db_sl_pred_inshole = groupsummary( ...
        pred_results_tbl(pred_db_sl_mask & nodup_mask, :), ...
        {'Ins_Hole'}, ...
        error_sumfuncs, ...
        error_varnames ...
    );
    
    %% Plotting Setup
    fig_num = 1;
    ax_pos_adj = [0, 0, 0, -0.05]; % adjust the height of the position
    max_yl = 1.25;

    %% Single-Bend Single-layer plots: FBG-Pred
    % Per Insertion Depth
    fig_sb_sl_summ_L = figure(fig_num);
    fig_num = fig_num + 1;
    set(fig_sb_sl_summ_L, 'units', 'normalized', 'position',[ 0, 0.0370, 1.0000, 0.8917 ]);
    
    % - RMSE
    ax_sb_sl_summ_L_RMSE = subplot(1,3,1);
    ax_sb_sl_summ_L_RMSE.Position = ax_sb_sl_summ_L_RMSE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.FBG_Pred_RMSE(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.L_ref(pred_sb_sl_mask & nodup_mask)...
    );
    ylabel("Error (mm)");
    xlabel("Insertion Depth (mm)");
    title("RMSE", "fontsize", 20);

    % - IPE
    ax_sb_sl_summ_L_IPE = subplot(1,3,2);
    ax_sb_sl_summ_L_IPE.Position = ax_sb_sl_summ_L_IPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.FBG_Pred_InPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.L_ref(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Insertion Depth (mm)");
    title("In-Plane Error", "fontsize", 20);
    
    % - OPE
    ax_sb_sl_summ_L_OPE = subplot(1,3,3);
    ax_sb_sl_summ_L_OPE.Position = ax_sb_sl_summ_L_OPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.FBG_Pred_OutPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.L_ref(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Insertion Depth (mm)");
    title("Out-of-Plane Error", "fontsize", 20);
    
    % - titling and limits
    sgtitle("Errors between Single-Bend Single-Layer FBG Reconstructed and Predicted Shapes per Insertion Depth",...
        'FontSize', 22, 'FontWeight', 'bold');
    ax_sb_sl_summ_L_RMSE.YLim = [0, max([ax_sb_sl_summ_L_RMSE.YLim,...
                                         ax_sb_sl_summ_L_IPE.YLim,...
                                         ax_sb_sl_summ_L_OPE.YLim,...
                                         max_yl ] ) ];
    ax_sb_sl_summ_L_IPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;
    ax_sb_sl_summ_L_OPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;

    % Per Tissue Stiffness
    fig_sb_sl_summ_L = figure(fig_num);
    fig_num = fig_num + 1;
    set(fig_sb_sl_summ_L, 'units', 'normalized', 'position',[ 0, 0.0370, 1.0000, 0.8917 ]);
    
    % - RMSE
    ax_sb_sl_summ_L_RMSE = subplot(1,3,1);
    ax_sb_sl_summ_L_RMSE.Position = ax_sb_sl_summ_L_RMSE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.FBG_Pred_RMSE(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.TissueType1(pred_sb_sl_mask & nodup_mask)...
    );
    ylabel("Error (mm)");
    xlabel("Tissue Stiffness");
    title("RMSE", "fontsize", 20);

    % - IPE
    ax_sb_sl_summ_L_IPE = subplot(1,3,2);
    ax_sb_sl_summ_L_IPE.Position = ax_sb_sl_summ_L_IPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.FBG_Pred_InPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.TissueType1(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Tissue Stiffness");
    title("In-Plane Error", "fontsize", 20);
    
    % - OPE
    ax_sb_sl_summ_L_OPE = subplot(1,3,3);
    ax_sb_sl_summ_L_OPE.Position = ax_sb_sl_summ_L_OPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.FBG_Pred_OutPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.TissueType1(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Tissue Stiffness");
    title("Out-of-Plane Error", "fontsize", 20);
    
    % - titling and limits
    sgtitle("Errors between Single-Bend Single-Layer FBG Reconstructed and Predicted Shapes per Tissue Stiffness",...
        'FontSize', 22, 'FontWeight', 'bold');
    ax_sb_sl_summ_L_RMSE.YLim = [0, max([ax_sb_sl_summ_L_RMSE.YLim,...
                                         ax_sb_sl_summ_L_IPE.YLim,...
                                         ax_sb_sl_summ_L_OPE.YLim,...
                                         max_yl ] ) ];
    ax_sb_sl_summ_L_IPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;
    ax_sb_sl_summ_L_OPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;
    
    % Per Insertion Depth Increment
    fig_sb_sl_summ_L = figure(fig_num);
    fig_num = fig_num + 1;
    set(fig_sb_sl_summ_L, 'units', 'normalized', 'position',[ 0, 0.0370, 1.0000, 0.8917 ]);
    
    % - RMSE
    ax_sb_sl_summ_L_RMSE = subplot(1,3,1);
    ax_sb_sl_summ_L_RMSE.Position = ax_sb_sl_summ_L_RMSE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.FBG_Pred_RMSE(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.dL(pred_sb_sl_mask & nodup_mask)...
    );
    ylabel("Error (mm)");
    xlabel("Insertion Depth Increment (mm)");
    title("RMSE", "fontsize", 20);

    % - IPE
    ax_sb_sl_summ_L_IPE = subplot(1,3,2);
    ax_sb_sl_summ_L_IPE.Position = ax_sb_sl_summ_L_IPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.FBG_Pred_InPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.dL(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Insertion Depth Increment (mm)");
    title("In-Plane Error", "fontsize", 20);
    
    % - OPE
    ax_sb_sl_summ_L_OPE = subplot(1,3,3);
    ax_sb_sl_summ_L_OPE.Position = ax_sb_sl_summ_L_OPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.FBG_Pred_OutPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.dL(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Insertion Depth Increment (mm)");
    title("Out-of-Plane Error", "fontsize", 20);
    
    % - titling and limits
    sgtitle("Errors between Single-Bend Single-Layer FBG Reconstructed and Predicted Shapes per Insertion Depth Increment",...
        'FontSize', 22, 'FontWeight', 'bold');
    ax_sb_sl_summ_L_RMSE.YLim = [0, max([ax_sb_sl_summ_L_RMSE.YLim,...
                                         ax_sb_sl_summ_L_IPE.YLim,...
                                         ax_sb_sl_summ_L_OPE.YLim,...
                                         max_yl ] ) ];
    ax_sb_sl_summ_L_IPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;
    ax_sb_sl_summ_L_OPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;

    %% Single-Bend Single-layer plots: Cam-Pred
    % Per Insertion Depth
    fig_sb_sl_summ_L = figure(fig_num);
    fig_num = fig_num + 1;
    set(fig_sb_sl_summ_L, 'units', 'normalized', 'position',[ 0, 0.0370, 1.0000, 0.8917 ]);
    
    % - RMSE
    ax_sb_sl_summ_L_RMSE = subplot(1,3,1);
    ax_sb_sl_summ_L_RMSE.Position = ax_sb_sl_summ_L_RMSE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.Pred_Cam_RMSE(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.L_ref(pred_sb_sl_mask & nodup_mask)...
    );
    ylabel("Error (mm)");
    xlabel("Insertion Depth (mm)");
    title("RMSE", "fontsize", 20);

    % - IPE
    ax_sb_sl_summ_L_IPE = subplot(1,3,2);
    ax_sb_sl_summ_L_IPE.Position = ax_sb_sl_summ_L_IPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.Pred_Cam_InPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.L_ref(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Insertion Depth (mm)");
    title("In-Plane Error", "fontsize", 20);
    
    % - OPE
    ax_sb_sl_summ_L_OPE = subplot(1,3,3);
    ax_sb_sl_summ_L_OPE.Position = ax_sb_sl_summ_L_OPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.Pred_Cam_OutPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.L_ref(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Insertion Depth (mm)");
    title("Out-of-Plane Error", "fontsize", 20);
    
    % - titling and limits
    sgtitle("Errors between Single-Bend Single-Layer Stereo Reconstructed and Predicted Shapes per Insertion Depth",...
        'FontSize', 22, 'FontWeight', 'bold');
    ax_sb_sl_summ_L_RMSE.YLim = [0, max([ax_sb_sl_summ_L_RMSE.YLim,...
                                         ax_sb_sl_summ_L_IPE.YLim,...
                                         ax_sb_sl_summ_L_OPE.YLim,...
                                         max_yl ] ) ];
    ax_sb_sl_summ_L_IPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;
    ax_sb_sl_summ_L_OPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;

    % Per Tissue Stiffness
    fig_sb_sl_summ_L = figure(fig_num);
    fig_num = fig_num + 1;
    set(fig_sb_sl_summ_L, 'units', 'normalized', 'position',[ 0, 0.0370, 1.0000, 0.8917 ]);
    
    % - RMSE
    ax_sb_sl_summ_L_RMSE = subplot(1,3,1);
    ax_sb_sl_summ_L_RMSE.Position = ax_sb_sl_summ_L_RMSE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.Pred_Cam_RMSE(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.TissueType1(pred_sb_sl_mask & nodup_mask)...
    );
    ylabel("Error (mm)");
    xlabel("Tissue Stiffness");
    title("RMSE", "fontsize", 20);

    % - IPE
    ax_sb_sl_summ_L_IPE = subplot(1,3,2);
    ax_sb_sl_summ_L_IPE.Position = ax_sb_sl_summ_L_IPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.Pred_Cam_InPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.TissueType1(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Tissue Stiffness");
    title("In-Plane Error", "fontsize", 20);
    
    % - OPE
    ax_sb_sl_summ_L_OPE = subplot(1,3,3);
    ax_sb_sl_summ_L_OPE.Position = ax_sb_sl_summ_L_OPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.Pred_Cam_OutPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.TissueType1(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Tissue Stiffness");
    title("Out-of-Plane Error", "fontsize", 20);
    
    % - titling and limits
    sgtitle("Errors between Single-Bend Single-Layer Stereo Reconstructed and Predicted Shapes per Tissue Stiffness",...
        'FontSize', 22, 'FontWeight', 'bold');
    ax_sb_sl_summ_L_RMSE.YLim = [0, max([ax_sb_sl_summ_L_RMSE.YLim,...
                                         ax_sb_sl_summ_L_IPE.YLim,...
                                         ax_sb_sl_summ_L_OPE.YLim,...
                                         max_yl ] ) ];
    ax_sb_sl_summ_L_IPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;
    ax_sb_sl_summ_L_OPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;
    
    % Per Insertion Depth Increment
    fig_sb_sl_summ_L = figure(fig_num);
    fig_num = fig_num + 1;
    set(fig_sb_sl_summ_L, 'units', 'normalized', 'position',[ 0, 0.0370, 1.0000, 0.8917 ]);
    
    % - RMSE
    ax_sb_sl_summ_L_RMSE = subplot(1,3,1);
    ax_sb_sl_summ_L_RMSE.Position = ax_sb_sl_summ_L_RMSE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.Pred_Cam_RMSE(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.dL(pred_sb_sl_mask & nodup_mask)...
    );
    ylabel("Error (mm)");
    xlabel("Insertion Depth Increment (mm)");
    title("RMSE", "fontsize", 20);

    % - IPE
    ax_sb_sl_summ_L_IPE = subplot(1,3,2);
    ax_sb_sl_summ_L_IPE.Position = ax_sb_sl_summ_L_IPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.Pred_Cam_InPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.dL(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Insertion Depth Increment (mm)");
    title("In-Plane Error", "fontsize", 20);
    
    % - OPE
    ax_sb_sl_summ_L_OPE = subplot(1,3,3);
    ax_sb_sl_summ_L_OPE.Position = ax_sb_sl_summ_L_OPE.Position + ax_pos_adj;
    boxplot(...
        pred_results_tbl.Pred_Cam_OutPlaneError(pred_sb_sl_mask & nodup_mask),...
        pred_results_tbl.dL(pred_sb_sl_mask & nodup_mask)...
    );
    xlabel("Insertion Depth Increment (mm)");
    title("Out-of-Plane Error", "fontsize", 20);
    
    % - titling and limits
    sgtitle("Errors between Single-Bend Single-Layer Stereo Reconstructed and Predicted Shapes per Insertion Depth Increment",...
        'FontSize', 22, 'FontWeight', 'bold');
    ax_sb_sl_summ_L_RMSE.YLim = [0, max([ax_sb_sl_summ_L_RMSE.YLim,...
                                         ax_sb_sl_summ_L_IPE.YLim,...
                                         ax_sb_sl_summ_L_OPE.YLim,...
                                         max_yl ] ) ];
    ax_sb_sl_summ_L_IPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;
    ax_sb_sl_summ_L_OPE.YLim = ax_sb_sl_summ_L_RMSE.YLim;

end
    